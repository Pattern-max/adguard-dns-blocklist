name: Sync Rules from HaGeZi
on:
  schedule:
    # æ¯å°æ—¶ç¬¬5åˆ†é’Ÿè¿è¡Œï¼ˆé¿å¼€æ•´ç‚¹é«˜å³°ï¼‰
    - cron: '5 * * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

# ðŸ” å¹¶å‘æŽ§åˆ¶ï¼šé˜²æ­¢é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Sync and Update Rules
        id: sync
        run: |
          # ========== ç›®å½•å‡†å¤‡ ==========
          mkdir -p rules logs
          
          # ========== è§„åˆ™æºå®šä¹‰ ==========
          declare -A rules=(
            ["pro.mini"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.mini.txt"
            ["tif.medium"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.medium.txt"
            ["spam-tlds"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          )
          
          # ========== 1. åŒæ­¥è§„åˆ™æ–‡ä»¶ ==========
          echo "ðŸ”„ å¼€å§‹åŒæ­¥è§„åˆ™..."
          any_rule_updated=false
          for rule in "${!rules[@]}"; do
            echo "ðŸ“¥ åŒæ­¥ ${rule}..."
            url="${rules[$rule]}"
            output_file="rules/${rule}.txt"
            temp_file="rules/${rule}.tmp.txt"
            
            # ä¸‹è½½ï¼ˆå¸¦é‡è¯•ï¼‰
            success=false
            for i in {1..3}; do
              if curl -s -L --retry 2 --max-time 30 -o "$temp_file" "$url" && [[ -s "$temp_file" ]]; then
                success=true
                break
              else
                echo "âš ï¸ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œ5ç§’åŽé‡è¯•..."
                sleep 5
              fi
            done
            
            if [[ "$success" != true ]]; then
              echo "âŒ æ— æ³•ä¸‹è½½ ${rule}ï¼Œè·³è¿‡"
              rm -f "$temp_file" 2>/dev/null
              continue
            fi
            
            # æ¯”è¾ƒå˜åŒ–
            if [[ -f "$output_file" ]] && cmp -s "$output_file" "$temp_file"; then
              echo "âœ… ${rule}: æ— å˜åŒ–"
              rm "$temp_file"
            else
              echo "âœ¨ ${rule}: æ£€æµ‹åˆ°æ›´æ–°"
              mv "$temp_file" "$output_file"
              any_rule_updated=true
            fi
          done
          
          # ========== 2. ç”ŸæˆçŠ¶æ€ä¿¡æ¯ ==========
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          NEXT_SYNC=$(date -u -d '+1 hour' +"%Y-%m-%d %H:%M:%S UTC")
          
          count_entries() {
            local file=$1
            if [[ -f "$file" ]]; then
              grep -v -E '^[[:space:]]*!|^[[:space:]]*$' "$file" | wc -l | tr -d ' '
            else
              echo "0"
            fi
          }
          
          PRO_COUNT=$(count_entries "rules/pro.mini.txt")
          TIF_COUNT=$(count_entries "rules/tif.medium.txt")
          SPAM_COUNT=$(count_entries "rules/spam-tlds.txt")
          
          # ========== 3. æ›´æ–° README.md ==========
          if [[ -f "README.md" ]]; then
            # ðŸ”‘ å…³é”®ä¿®å¤ï¼šYAML å®‰å…¨è½¬ä¹‰ï¼ˆ\\| é¿å…è§£æžé”™è¯¯ï¼‰
            sed -i "s/\\| pro\\.mini\\.txt \\|.*|/\\| pro.mini.txt \\| $CURRENT_TIME \\| $PRO_COUNT \\|/" README.md
            sed -i "s/\\| tif\\.medium\\.txt \\|.*|/\\| tif.medium.txt \\| $CURRENT_TIME \\| $TIF_COUNT \\|/" README.md
            sed -i "s/\\| spam-tlds\\.txt \\|.*|/\\| spam-tlds.txt \\| $CURRENT_TIME \\| $SPAM_COUNT \\|/" README.md
            sed -i "s/æœ€åŽåŒæ­¥æ—¶é—´:.*/æœ€åŽåŒæ­¥æ—¶é—´: $CURRENT_TIME/" README.md
            sed -i "s/ä¸‹æ¬¡åŒæ­¥:.*/ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC/" README.md
            echo "âœ… README.md å·²æ›´æ–°"
          else
            # åˆ›å»ºæ–° README
            cat > README.md << 'EOF'
# ðŸ›¡ï¸ AdGuardè§„åˆ™åŒæ­¥ä»“åº“

æœ¬é¡¹ç›®è‡ªåŠ¨åŒæ­¥HaGeZiæŽ¨èçš„ä¼˜åŒ–ç‰ˆAdGuardè§„åˆ™ï¼Œé€‚ç”¨äºŽAdGuard Homeã€AdGuard for Windows/macOSç­‰ã€‚

## ðŸ“¦ åŒ…å«è§„åˆ™

| è§„åˆ™ | ç‰ˆæœ¬ | æŽ¨èç”¨é€” | RAWé“¾æŽ¥ |
|------|------|----------|---------|
| Proåˆ—è¡¨ | miniç‰ˆ | å¹¿å‘Šã€è·Ÿè¸ªå™¨æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/pro.mini.txt) |
| TIFåˆ—è¡¨ | mediumç‰ˆ | å¨èƒã€æ¶æ„è½¯ä»¶æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/tif.medium.txt) |
| Spam TLDs | å®Œæ•´ç‰ˆ | æ»¥ç”¨é¡¶çº§åŸŸåæ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/spam-tlds.txt) |

## ðŸš€ ä½¿ç”¨æ–¹æ³•

åœ¨AdGuard Homeä¸­ï¼š
1. è¿›å…¥ **è¿‡æ»¤å™¨** â†’ **DNSå°é”æ¸…å•**
2. ç‚¹å‡» **æ·»åŠ é˜»æ­¢åˆ—è¡¨**
3. ç²˜è´´ä¸Šæ–¹RAWé“¾æŽ¥
4. è®¾ç½®æ›´æ–°é—´éš”ï¼ˆå»ºè®®24å°æ—¶ï¼‰

## ðŸ”„ åŒæ­¥çŠ¶æ€

**æœ€åŽåŒæ­¥æ—¶é—´:** 2026-02-09 16:00:00 UTC  
**ä¸‹æ¬¡åŒæ­¥:** 2026-02-09 17:00:00 UTC  
**ä»“åº“æ´»è·ƒçŠ¶æ€:** âœ… æ­£å¸¸  

## ðŸ“Š è§„åˆ™ç»Ÿè®¡

| è§„åˆ™ | æœ€åŽæ›´æ–° | æ¡ç›®æ•° |
|------|----------|--------|
| pro.mini.txt | 2026-02-09 16:00:00 UTC | 0 |
| tif.medium.txt | 2026-02-09 16:00:00 UTC | 0 |
| spam-tlds.txt | 2026-02-09 16:00:00 UTC | 0 |

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

- **åŒæ­¥é¢‘çŽ‡:** æ¯å°æ—¶ä¸€æ¬¡
- **å¤±è´¥é‡è¯•:** 3æ¬¡
- **ç›‘æŽ§:** GitHub Actionsè‡ªåŠ¨ç›‘æŽ§

---
*è‡ªåŠ¨åŒæ­¥è‡ª [HaGeZi's DNS Blocklists](https://github.com/hagezi/dns-blocklists)*
EOF
            echo "âœ… README.md å·²åˆ›å»º"
          fi
          
          # ========== 4. ç”ŸæˆçŠ¶æ€æ–‡ä»¶ ==========
          cat > sync-status.txt << EOF
æœ€åŽåŒæ­¥: $CURRENT_TIME
ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC
è§„åˆ™ç»Ÿè®¡:
- pro.mini.txt: $PRO_COUNT æ¡
- tif.medium.txt: $TIF_COUNT æ¡
- spam-tlds.txt: $SPAM_COUNT æ¡
ç”ŸæˆäºŽ: $CURRENT_TIME
EOF
          
          # ========== 5. è®°å½•æ—¥å¿— ==========
          echo "[$(date -u +'%Y-%m-%d %H:%M:%S UTC')] åŒæ­¥å®Œæˆ" >> "logs/sync-$(date -u +'%Y-%m-%d').log"
          
          # ========== 6. è®¾ç½®è¾“å‡ºå˜é‡ ==========
          if [[ "$any_rule_updated" = true ]]; then
            echo "update_type=rules_and_status" >> "$GITHUB_OUTPUT"
          else
            echo "update_type=status_only" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and Push Changes
        if: steps.sync.outputs.update_type == 'rules_and_status' || steps.sync.outputs.update_type == 'status_only'
        run: |
          echo "ðŸ“¦ å‡†å¤‡æäº¤æ›´æ”¹..."
          
          # é…ç½® Git
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # æ·»åŠ æ›´æ”¹
          git add rules/ README.md sync-status.txt logs/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®žé™…æ›´æ”¹
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å†…å®¹æ›´æ”¹ï¼Œä»…æ›´æ–°æ—¶é—´æˆ³ï¼ˆè·³è¿‡æäº¤ï¼‰"
            exit 0
          fi
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          UPDATE_TYPE="${{ steps.sync.outputs.update_type }}"
          if [[ "$UPDATE_TYPE" == "rules_and_status" ]]; then
            COMMIT_MSG="ðŸ¤– åŒæ­¥è§„åˆ™æ›´æ–° - $(date -u +'%Y-%m-%d %H:%M UTC')"
          else
            COMMIT_MSG="ðŸ“Š æ›´æ–°åŒæ­¥çŠ¶æ€ - $(date -u +'%Y-%m-%d %H:%M UTC')"
          fi
          
          # å®‰å…¨æäº¤ï¼ˆé¿å…ç©ºæäº¤ï¼‰
          git commit -m "$COMMIT_MSG" || echo "âš ï¸ æäº¤å¤±è´¥ï¼ˆå¯èƒ½æ— æ›´æ”¹ï¼‰"
          git push || echo "âš ï¸ æŽ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ— æ–°æäº¤ï¼‰"
          echo "âœ… æ›´æ”¹å·²å¤„ç†"

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ“Š åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "sync-status.txt" ]]; then
            LAST_SYNC=$(grep "æœ€åŽåŒæ­¥:" sync-status.txt | cut -d':' -f2- | xargs)
            NEXT_SYNC=$(grep "ä¸‹æ¬¡åŒæ­¥:" sync-status.txt | cut -d':' -f2- | xargs)
            PRO_COUNT=$(grep "pro.mini.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            TIF_COUNT=$(grep "tif.medium.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            SPAM_COUNT=$(grep "spam-tlds.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            
            echo "- **âœ… æœ€åŽåŒæ­¥**: $LAST_SYNC" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ• ä¸‹æ¬¡åŒæ­¥**: $NEXT_SYNC" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ“¦ Pro Mini**: $PRO_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ›¡ï¸ TIF Medium**: $TIF_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ“§ Spam TLDs**: $SPAM_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ”„ æ›´æ–°ç±»åž‹**: ${{ steps.sync.outputs.update_type }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ çŠ¶æ€æ–‡ä»¶ç¼ºå¤±ï¼ŒåŒæ­¥å¯èƒ½å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ˜¾ç¤º git çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ä»“åº“çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          git status --short >> $GITHUB_STEP_SUMMARY || echo "æ— æ³•èŽ·å–çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
