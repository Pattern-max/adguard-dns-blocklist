name: Sync Rules from HaGeZi
on:
  schedule:
    # æ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿè¿è¡Œï¼ˆé¿å…æ•´ç‚¹é«˜å³°ï¼‰
    - cron: '5 * * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

# ðŸ” å¹¶å‘æŽ§åˆ¶ï¼šé˜²æ­¢åŒä¸€åˆ†æ”¯ä¸Šå¤šä¸ªå·¥ä½œæµåŒæ—¶è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.sync.outputs.updated }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Sync Rules
        id: sync
        run: |
          # åˆ›å»ºè§„åˆ™ç›®å½•
          mkdir -p rules logs
          
          # å®šä¹‰è§„åˆ™æº
          declare -A rules=(
            ["pro.mini"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.mini.txt"
            ["tif.medium"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.medium.txt"
            ["spam-tlds"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          )
          
          # åŒæ­¥æ¯ä¸ªè§„åˆ™
          updated=false
          for rule in "${!rules[@]}"; do
            echo "Syncing ${rule}..."
            url="${rules[$rule]}"
            
            # ä¸‹è½½è§„åˆ™ï¼Œå¸¦é‡è¯•æœºåˆ¶
            for i in {1..3}; do
              if curl -s -L --retry 3 --max-time 30 -o "rules/${rule}.tmp.txt" "$url"; then
                break
              else
                echo "Attempt $i failed, retrying..."
                sleep 5
              fi
            done
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éžç©º
            if [[ ! -s "rules/${rule}.tmp.txt" ]]; then
              echo "Warning: Downloaded file for ${rule} is empty or missing!"
              rm -f "rules/${rule}.tmp.txt"
              continue
            fi
            
            # æ¯”è¾ƒæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
            if [[ -f "rules/${rule}.txt" ]] && cmp -s "rules/${rule}.txt" "rules/${rule}.tmp.txt"; then
              echo "No changes for ${rule}"
              rm "rules/${rule}.tmp.txt"
            else
              echo "Updating ${rule}"
              mv "rules/${rule}.tmp.txt" "rules/${rule}.txt"
              updated=true
            fi
          done
          
          # å¦‚æžœæœ‰æ›´æ–°ï¼Œæäº¤æ›´æ”¹
          if [[ "$updated" = true ]]; then
            # æ›´æ–°åŒæ­¥æ—¶é—´æˆ³
            date -u +"%Y-%m-%d %H:%M:%S UTC" > update-timestamp.txt
            
            # é…ç½®git
            git config --global user.name 'GitHub Actions Bot'
            git config --global user.email 'actions@github.com'
            
            # æ·»åŠ ã€æäº¤å’ŒæŽ¨é€
            git add rules/ update-timestamp.txt
            git commit -m "ðŸ¤– Sync rules - $(date -u +'%Y-%m-%d %H:%M')"
            git push
            
            # è®¾ç½®è¾“å‡ºå˜é‡
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No updates needed"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi
          
          # è®°å½•æ—¥å¿—
          echo "Sync completed at $(date)" >> logs/sync-$(date +%Y-%m-%d).log

      - name: Generate Status Report
        if: always()
        run: |
          echo "## ðŸ“Š Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Sync:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          # æ›´å‡†ç¡®çš„æ¡ç›®ç»Ÿè®¡ï¼ˆæŽ’é™¤æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼‰
          count_entries() {
            local file=$1
            if [[ -f "$file" ]]; then
              grep -v -E '^[[:space:]]*!|^[[:space:]]*$' "$file" | wc -l || echo "0"
            else
              echo "0"
            fi
          }
          
          PRO_COUNT=$(count_entries "rules/pro.mini.txt")
          TIF_COUNT=$(count_entries "rules/tif.medium.txt")
          SPAM_COUNT=$(count_entries "rules/spam-tlds.txt")
          
          echo "- **Pro Mini Rules:** $PRO_COUNT entries" >> $GITHUB_STEP_SUMMARY
          echo "- **TIF Medium Rules:** $TIF_COUNT entries" >> $GITHUB_STEP_SUMMARY
          echo "- **Spam TLDs:** $SPAM_COUNT entries" >> $GITHUB_STEP_SUMMARY
          
          # ç”Ÿæˆä¸‹æ¬¡åŒæ­¥æ—¶é—´ï¼ˆå½“å‰æ—¶é—´+1å°æ—¶ï¼‰
          NEXT_SYNC=$(date -u -d '+1 hour' +"%Y-%m-%d %H:%M:%S UTC")
          echo "- **Next Sync:** $NEXT_SYNC" >> $GITHUB_STEP_SUMMARY

      - name: Update README Status
        if: always()
        run: |
          # èŽ·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          NEXT_SYNC=$(date -u -d '+1 hour' +"%Y-%m-%d %H:%M:%S UTC")
          
          # ç»Ÿè®¡å®žé™…æ¡ç›®æ•°ï¼ˆæŽ’é™¤æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼‰
          count_entries() {
            local file=$1
            if [[ -f "$file" ]]; then
              grep -v -E '^[[:space:]]*!|^[[:space:]]*$' "$file" | wc -l || echo "0"
            else
              echo "0"
            fi
          }
          
          PRO_COUNT=$(count_entries "rules/pro.mini.txt")
          TIF_COUNT=$(count_entries "rules/tif.medium.txt")
          SPAM_COUNT=$(count_entries "rules/spam-tlds.txt")
          
          # æ›´æ–°README.mdæ–‡ä»¶
          if [[ -f "README.md" ]]; then
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            cp README.md README.md.tmp
            
            # æ›´æ–°åŒæ­¥çŠ¶æ€éƒ¨åˆ†
            sed -i "s/æœ€åŽåŒæ­¥æ—¶é—´:.*/æœ€åŽåŒæ­¥æ—¶é—´: $CURRENT_TIME/" README.md.tmp
            sed -i "s/ä¸‹æ¬¡åŒæ­¥:.*/ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC/" README.md.tmp
            
            # æ›´æ–°è§„åˆ™ç»Ÿè®¡è¡¨æ ¼
            sed -i "s/| pro.mini.txt |.*|/| pro.mini.txt | $CURRENT_TIME | $PRO_COUNT |/" README.md.tmp
            sed -i "s/| tif.medium.txt |.*|/| tif.medium.txt | $CURRENT_TIME | $TIF_COUNT |/" README.md.tmp
            sed -i "s/| spam-tlds.txt |.*|/| spam-tlds.txt | $CURRENT_TIME | $SPAM_COUNT |/" README.md.tmp
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if ! cmp -s README.md README.md.tmp; then
              echo "Updating README.md with new status"
              mv README.md.tmp README.md
              
              # æäº¤æ›´æ–°
              git config --global user.name 'GitHub Actions Bot'
              git config --global user.email 'actions@github.com'
              git add README.md
              git commit -m "ðŸ“Š Update sync status - $(date -u +'%Y-%m-%d %H:%M')"
              git push
            else
              echo "README.md already up to date"
              rm README.md.tmp
            fi
          else
            echo "README.md not found, creating one..."
            # åˆ›å»ºåŸºæœ¬çš„README.md
            cat > README.md << 'EOF'
# ðŸ›¡ï¸ AdGuardè§„åˆ™åŒæ­¥ä»“åº“

æœ¬é¡¹ç›®è‡ªåŠ¨åŒæ­¥HaGeZiæŽ¨èçš„ä¼˜åŒ–ç‰ˆAdGuardè§„åˆ™ï¼Œé€‚ç”¨äºŽAdGuard Homeã€‚

## ðŸ“¦ åŒ…å«è§„åˆ™

| è§„åˆ™ | ç‰ˆæœ¬ | æŽ¨èç”¨é€” | RAWé“¾æŽ¥ |
|------|------|----------|---------|
| Proåˆ—è¡¨ | miniç‰ˆ | å¹¿å‘Šã€è·Ÿè¸ªå™¨æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/rules/pro.mini.txt) |
| TIFåˆ—è¡¨ | mediumç‰ˆ | å¨èƒã€æ¶æ„è½¯ä»¶æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/rules/tif.medium.txt) |
| Spam TLDs | å®Œæ•´ç‰ˆ | æ»¥ç”¨é¡¶çº§åŸŸåæ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/rules/spam-tlds.txt) |

## ðŸš€ ä½¿ç”¨æ–¹æ³•

åœ¨AdGuard Homeä¸­ï¼š
1. è¿›å…¥ **è¿‡æ»¤å™¨** â†’ **DNSå°é”æ¸…å•**
2. ç‚¹å‡» **æ·»åŠ é˜»æ­¢åˆ—è¡¨**
3. ç²˜è´´ä¸Šæ–¹RAWé“¾æŽ¥
4. è®¾ç½®é€‚å½“çš„æ›´æ–°é—´éš”ï¼ˆå»ºè®®24å°æ—¶ï¼‰

## ðŸ”„ åŒæ­¥çŠ¶æ€

**æœ€åŽåŒæ­¥æ—¶é—´:** $CURRENT_TIME  
**ä¸‹æ¬¡åŒæ­¥:** $NEXT_SYNC  
**ä»“åº“æ´»è·ƒçŠ¶æ€:** âœ… æ­£å¸¸  

## ðŸ“Š è§„åˆ™ç»Ÿè®¡

| è§„åˆ™ | æœ€åŽæ›´æ–° | æ¡ç›®æ•° |
|------|----------|--------|
| pro.mini.txt | $CURRENT_TIME | $PRO_COUNT |
| tif.medium.txt | $CURRENT_TIME | $TIF_COUNT |
| spam-tlds.txt | $CURRENT_TIME | $SPAM_COUNT |

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

- **åŒæ­¥é¢‘çŽ‡:** æ¯å°æ—¶ä¸€æ¬¡
- **å¤±è´¥é‡è¯•:** 3æ¬¡
- **ç›‘æŽ§:** GitHub Actionsè‡ªåŠ¨ç›‘æŽ§

---
*è‡ªåŠ¨åŒæ­¥è‡ª [HaGeZi's DNS Blocklists](https://github.com/hagezi/dns-blocklists)*
EOF
            
            # æ›¿æ¢å ä½ç¬¦
            sed -i "s/\$CURRENT_TIME/$CURRENT_TIME/g" README.md
            sed -i "s/\$NEXT_SYNC/$NEXT_SYNC/g" README.md
            sed -i "s/\$PRO_COUNT/$PRO_COUNT/g" README.md
            sed -i "s/\$TIF_COUNT/$TIF_COUNT/g" README.md
            sed -i "s/\$SPAM_COUNT/$SPAM_COUNT/g" README.md
            
            # æäº¤æ–°README
            git config --global user.name 'GitHub Actions Bot'
            git config --global user.email 'actions@github.com'
            git add README.md
            git commit -m "ðŸ“ Create README with sync status"
            git push
          fi
          
          # æ›´æ–°çŠ¶æ€æ–‡ä»¶
          echo "Sync Status" > sync-status.txt
          echo "===========" >> sync-status.txt
          echo "Last Sync: $CURRENT_TIME" >> sync-status.txt
          echo "Next Sync: $NEXT_SYNC" >> sync-status.txt
          echo "" >> sync-status.txt
          echo "Rule Statistics" >> sync-status.txt
          echo "===============" >> sync-status.txt
          echo "pro.mini.txt: $PRO_COUNT entries" >> sync-status.txt
          echo "tif.medium.txt: $TIF_COUNT entries" >> sync-status.txt
          echo "spam-tlds.txt: $SPAM_COUNT entries" >> sync-status.txt
          echo "" >> sync-status.txt
          echo "Generated at: $CURRENT_TIME" >> sync-status.txt
